<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë¶€ì‚°ë§›ì§‘ ì •ë³´ ì„œë¹„ìŠ¤</title>
  <style>
    :root {
      --bg: #0b0d12;
      --panel: #111522;
      --panel2: #0f1320;
      --text: #e7e9ee;
      --muted: #a8afbf;
      --line: rgba(255,255,255,.08);
      --accent: #ffd84d;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --gap: 16px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(255,216,77,.08), transparent 60%),
                  radial-gradient(900px 500px at 90% 40%, rgba(91,191,255,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    a { color: inherit; text-decoration: none; }

    /* ====== App Shell ====== */
    .app {
      max-width: 1080px;
      margin: 0 auto;
      padding: 20px 14px 40px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 4px 18px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      user-select: none;
    }

    .logo {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(255,216,77,.9), rgba(255,216,77,.25));
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    .logo::after {
      content: "";
      position: absolute;
      inset: -20px -10px auto auto;
      width: 60px;
      height: 60px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 60%);
      transform: rotate(25deg);
    }

    .brand h1 {
      font-size: 18px;
      margin: 0;
      letter-spacing: -0.4px;
      line-height: 1;
    }

    .brand p {
      margin: 2px 0 0;
      color: var(--muted);
      font-size: 12px;
      letter-spacing: -0.2px;
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .search {
      display: flex;
      gap: 8px;
      align-items: center;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      padding: 10px 12px;
      border-radius: 999px;
      min-width: 240px;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }

    .search input {
      width: 100%;
      background: transparent;
      border: 0;
      color: var(--text);
      outline: none;
      font-size: 13px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
      transition: .15s ease;
      user-select: none;
    }
    .pill:hover { transform: translateY(-1px); color: var(--text); }
    .pill:active { transform: translateY(0px); }

    /* ====== Layout ====== */
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--gap);
    }

    @media (min-width: 900px) {
      .grid {
        grid-template-columns: 1.1fr .9fr;
        align-items: start;
      }
    }

    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    /* ====== Detail Left (Photo + Map) ====== */
    .detail-left {
      padding: 0;
    }

    .hero {
      position: relative;
      height: 250px;
      background: #111;
    }

    .hero img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: saturate(1.05);
    }

    .hero .fav {
      position: absolute;
      top: 14px;
      left: 14px;
      width: 42px;
      height: 42px;
      display: grid;
      place-items: center;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      cursor: pointer;
      user-select: none;
      transition: .15s ease;
    }
    .hero .fav:hover { transform: translateY(-1px); }

    .hero .fav svg { width: 20px; height: 20px; }

    .map {
      height: 270px;
      width: 100%;
      background: #0e111a;
      border-top: 1px solid var(--line);
    }

    /* ====== Detail Right (Info) ====== */
    .detail-right {
      padding: 16px;
    }

    .kv {
      display: grid;
      gap: 12px;
    }

    .kv-row {
      display: grid;
      grid-template-columns: 88px 1fr;
      gap: 12px;
      align-items: start;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(0,0,0,.35);
      border: 1px solid var(--line);
      color: rgba(255,255,255,.92);
      font-weight: 700;
      font-size: 12px;
      letter-spacing: -0.2px;
    }

    .val {
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      word-break: keep-all;
    }

    .val.muted { color: var(--muted); }

    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 14px 0 10px;
      color: rgba(255,255,255,.92);
      font-weight: 800;
      letter-spacing: -0.2px;
    }

    .section-title::before {
      content: "";
      width: 9px;
      height: 9px;
      border-radius: 99px;
      background: var(--accent);
      box-shadow: 0 0 0 5px rgba(255,216,77,.12);
    }

    .menu-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 13px;
    }

    .btn {
      margin-top: 14px;
      width: 100%;
      padding: 12px 14px;
      border: 1px solid rgba(255,216,77,.35);
      background: linear-gradient(180deg, rgba(255,216,77,.22), rgba(255,216,77,.08));
      color: rgba(255,255,255,.95);
      border-radius: 14px;
      cursor: pointer;
      font-weight: 800;
      letter-spacing: -0.3px;
      transition: .15s ease;
      user-select: none;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0px); }

    /* ====== List View ====== */
    .list {
      margin-top: 16px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .list-item {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      padding: 14px 14px;
      border-top: 1px solid var(--line);
      align-items: center;
      cursor: pointer;
      transition: .15s ease;
    }
    .list-item:first-child { border-top: 0; }
    .list-item:hover { background: rgba(255,255,255,.05); }

    .li-title {
      font-weight: 900;
      letter-spacing: -0.4px;
      font-size: 15px;
      margin: 0 0 6px;
    }
    .li-meta {
      margin: 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    .li-actions {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      color: var(--muted);
      user-select: none;
    }

    .icon-btn {
      width: 34px;
      height: 34px;
      display: grid;
      place-items: center;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.25);
      transition: .15s ease;
    }
    .icon-btn:hover { transform: translateY(-1px); color: var(--text); }

    .footer {
      color: var(--muted);
      font-size: 12px;
      margin-top: 16px;
      line-height: 1.5;
      opacity: .9;
    }

    .notice {
      margin-top: 14px;
      padding: 12px 14px;
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: 14px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.55;
      background: rgba(0,0,0,.18);
    }

    .hidden { display: none !important; }

    /* Skeleton */
    .skeleton {
      position: relative;
      overflow: hidden;
      background: rgba(255,255,255,.05);
    }
    .skeleton::after {
      content: "";
      position: absolute;
      inset: 0;
      transform: translateX(-100%);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.10), transparent);
      animation: shimmer 1.1s infinite;
    }
    @keyframes shimmer {
      100% { transform: translateX(100%); }
    }

  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand" id="goHome" role="button" tabindex="0" aria-label="í™ˆìœ¼ë¡œ">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>ë¶€ì‚°ë§›ì§‘ ì •ë³´</h1>
          <p>ê³µê³µë°ì´í„° ê¸°ë°˜ Â· ì¹´ì¹´ì˜¤ë§µ</p>
        </div>
      </div>

      <div class="controls">
        <div class="search" title="ê°€ê²Œëª…/ì£¼ì†Œ/ë©”ë‰´ë¡œ ê²€ìƒ‰">
          <span aria-hidden="true">ğŸ”</span>
          <input id="q" type="text" placeholder="ê°€ê²Œëª…/ì£¼ì†Œ/ë©”ë‰´ ê²€ìƒ‰" autocomplete="off" />
        </div>
        <button class="pill" id="refreshBtn" type="button">â†» ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </header>

    <!-- Detail View (ì‹œì•ˆ ìƒë‹¨) -->
    <section class="grid" id="detailView">
      <article class="panel detail-left">
        <div class="hero" id="hero">
          <img id="heroImg" alt="ë§›ì§‘ ì´ë¯¸ì§€" />
          <div class="fav" id="favBtn" title="ì¦ê²¨ì°¾ê¸°">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M12 21s-7-4.6-9.5-8.5C0 9 2 5.8 5.7 5.2c2-.3 3.6.6 4.5 1.8.9-1.2 2.5-2.1 4.5-1.8C18.4 5.8 20.4 9 21.5 12.5 19 16.4 12 21 12 21z" stroke="rgba(255,255,255,.92)" stroke-width="1.6"/>
            </svg>
          </div>
        </div>
        <div class="map" id="map" aria-label="ì¹´ì¹´ì˜¤ ì§€ë„"></div>
      </article>

      <!-- <aside class="panel detail-right">
        <div class="kv" id="detailPanel"> -->
          <!-- Filled by JS -->
        <!-- </div>

        <div class="notice" id="kakaoNotice">
          <b>ì¤‘ìš”:</b> ì¹´ì¹´ì˜¤ë§µ í‘œì‹œë¥¼ ìœ„í•´ <b>Kakao Maps JavaScript SDK</b>ì˜ <b>ì•±í‚¤</b>ê°€ í•„ìš”í•©ë‹ˆë‹¤.
          <br/>ì•„ë˜ ì½”ë“œì˜ <code>YOUR_KAKAO_JS_KEY</code>ë¥¼ ë³¸ì¸ ì•±í‚¤ë¡œ êµì²´í•˜ì„¸ìš”.
        </div>
      </aside> -->
    </section>

    <!-- List View (ì‹œì•ˆ í•˜ë‹¨) -->
    <section class="list" id="listView" aria-label="ë§›ì§‘ ëª©ë¡">
      <!-- Filled by JS -->
    </section>

    <div class="footer">
      ë°ì´í„° ì¶œì²˜: ë¶€ì‚°ê´‘ì—­ì‹œ ê³µê³µë°ì´í„°í¬í„¸(ë¶€ì‚°ë§›ì§‘ ì •ë³´, FoodService API)
      <br/>â€» ì¼ë¶€ í•­ëª©ì€ ì¢Œí‘œ/ì´ë¯¸ì§€/ìš´ì˜ì‹œê°„ ë“± ì •ë³´ê°€ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>
  </div>

  <!-- Kakao Maps SDK (ë³¸ì¸ ì•±í‚¤ í•„ìš”) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=12bbe0a7710edf7c1ee095813343dd12&autoload=false"></script>

  <script>
    /**********************
     * 1) ì„¤ì •
     **********************/
    const API_BASE = "https://apis.data.go.kr/6260000/FoodService";
    const SERVICE_KEY = "1e6ef0543aaf7d4b206257b3ddefaeda53c8430d5ab4b8c224af6db8cc6ba353";

    // ê³µê³µë°ì´í„° APIëŠ” ì¶œë ¥ í¬ë§·/íŒŒë¼ë¯¸í„° ì´ë¦„ì´ ì¢…ì¢… ë°”ë€ë‹ˆë‹¤.
    // ì´ í”„ë¡œì íŠ¸ëŠ” ì•ˆì „í•˜ê²Œ XML/JSON ë‘˜ ë‹¤ ëŒ€ì‘ ê°€ëŠ¥í•œ íŒŒì„œë¥¼ ë„£ì—ˆìŠµë‹ˆë‹¤.
    // (ì‹¤ì„œë¹„ìŠ¤ ì ìš© ì‹œ, ì‹¤ì œ ì‘ë‹µ ìŠ¤í‚¤ë§ˆë¥¼ í™•ì¸í•´ ì•„ë˜ FIELD_MAPì„ ì¡°ì •í•˜ì„¸ìš”.)
    const FIELD_MAP = {
      // ê°€ì¥ í”í•œ í•„ë“œëª… í›„ë³´ë“¤ì„ ë°°ì—´ë¡œ ë‘¬ì„œ ìœ ì—°í•˜ê²Œ ë§¤í•‘
      title: ["MAIN_TITLE", "title", "name", "restaurantName"],
      addr: ["ADDR1", "address", "addr", "ROAD_ADDR"],
      tel: ["CNTCT_TEL", "tel", "phone"],
      usageTime: ["USAGE_DAY_WEEK_AND_TIME", "usageTime", "openHours"],
      menu: ["RPRSNTV_MENU", "menu", "representativeMenu"],
      desc: ["ITEMCNTNTS", "description", "desc", "content"],
      lat: ["LAT", "lat", "WGS84_LAT"],
      lng: ["LNG", "lon", "lng", "WGS84_LON"],
      img: ["MAIN_IMG_NORMAL", "img", "image", "imageUrl"],
      homepage: ["HOMEPAGE_URL", "homepage", "url"],
    };

    // ê¸°ë³¸ ëŒ€ì²´ ì´ë¯¸ì§€ (ë¬´ë£Œ, í•«ë§í¬. ìš´ì˜ ì‹œì—ëŠ” ë¡œì»¬/ìì²´ CDN ê¶Œì¥)
    const FALLBACK_IMG = "https://images.unsplash.com/photo-1550547660-d9450f859349?auto=format&fit=crop&w=1600&q=70";

    /**********************
     * 2) ìƒíƒœ
     **********************/
    const state = {
      items: [],
      filtered: [],
      selected: null,
      favorites: new Set(JSON.parse(localStorage.getItem("busan_food_favs") || "[]")),
      map: null,
      marker: null,
    };

    /**********************
     * 3) ìœ í‹¸
     **********************/
    const $ = (sel) => document.querySelector(sel);

    function pick(obj, candidates) {
      for (const key of candidates) {
        if (obj && obj[key] != null && String(obj[key]).trim() !== "") return obj[key];
      }
      return "";
    }

    function normalizeMenu(menuStr) {
      if (!menuStr) return [];
      // ê³µê³µë°ì´í„°ëŠ” ë©”ë‰´ê°€ ì½¤ë§ˆ/ìŠ¬ë˜ì‹œ/ê°œí–‰ ë“± í˜¼í•©
      return String(menuStr)
        .split(/[,/\n]/g)
        .map(s => s.trim())
        .filter(Boolean)
        .slice(0, 10);
    }

    function safeNumber(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function toItem(raw, idx) {
      return {
        id: raw?.UC_SEQ ?? raw?.id ?? String(idx),
        title: pick(raw, FIELD_MAP.title) || "(ì´ë¦„ ì—†ìŒ)",
        addr: pick(raw, FIELD_MAP.addr) || "(ì£¼ì†Œ ì •ë³´ ì—†ìŒ)",
        tel: pick(raw, FIELD_MAP.tel) || "(ì „í™” ì •ë³´ ì—†ìŒ)",
        usageTime: pick(raw, FIELD_MAP.usageTime) || "(ìš´ì˜ì‹œê°„ ì •ë³´ ì—†ìŒ)",
        menuRaw: pick(raw, FIELD_MAP.menu),
        menus: normalizeMenu(pick(raw, FIELD_MAP.menu)),
        desc: pick(raw, FIELD_MAP.desc) || "(ì†Œê°œ ì •ë³´ ì—†ìŒ)",
        lat: safeNumber(pick(raw, FIELD_MAP.lat)),
        lng: safeNumber(pick(raw, FIELD_MAP.lng)),
        img: pick(raw, FIELD_MAP.img) || "",
        homepage: pick(raw, FIELD_MAP.homepage) || "",
        _raw: raw,
      };
    }

    function saveFavorites() {
      localStorage.setItem("busan_food_favs", JSON.stringify(Array.from(state.favorites)));
    }

    function isFav(id) {
      return state.favorites.has(String(id));
    }

    function toggleFav(id) {
      const key = String(id);
      if (state.favorites.has(key)) state.favorites.delete(key);
      else state.favorites.add(key);
      saveFavorites();
      renderList();
      renderDetail();
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    /**********************
     * 4) API í˜¸ì¶œ
     **********************/
    async function fetchFoodList() {
      // FoodServiceëŠ” ì—¬ëŸ¬ ì—”ë“œí¬ì¸íŠ¸ê°€ ì¡´ì¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      // ì•„ë˜ëŠ” ì¼ë°˜ì ìœ¼ë¡œ ì“°ì´ëŠ” íŒ¨í„´: /getFoodKr (ì˜ˆì‹œ)
      // ì‹¤ì œë¡œ 404 ë˜ëŠ” íŒŒë¼ë¯¸í„° ì˜¤ë¥˜ê°€ ë‚˜ë©´, ê°œë°œì ë„êµ¬(Network)ì—ì„œ ì‘ë‹µ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ê³ 
      // endpoint ë° paramsë¥¼ ë§ì¶° ì£¼ì„¸ìš”.
      const endpointCandidates = [
        "getFoodKr",
        "getFood",
        "getFoodService",
      ];

      const commonParams = new URLSearchParams({
        serviceKey: SERVICE_KEY,
        pageNo: "1",
        numOfRows: "50",
        resultType: "json", // json ìš°ì„  ì‹œë„
      });

      let lastError = null;

      for (const ep of endpointCandidates) {
        const url = `${API_BASE}/${ep}?${commonParams.toString()}`;
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const text = await res.text();
          // JSONì´ ì•„ë‹ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ì•ˆì „ íŒŒì‹±
          const data = tryParseJson(text) ?? tryParseXmlToJson(text);
          if (!data) throw new Error("ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨(ì§€ì›ë˜ì§€ ì•ŠëŠ” í¬ë§·)");

          const items = extractItems(data);
          if (!Array.isArray(items) || items.length === 0) {
            throw new Error("ì•„ì´í…œ ë°°ì—´ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤(ìŠ¤í‚¤ë§ˆ í™•ì¸ í•„ìš”)");
          }

          return items;
        } catch (err) {
          lastError = err;
        }
      }

      throw lastError ?? new Error("API í˜¸ì¶œ ì‹¤íŒ¨");
    }

    function tryParseJson(text) {
      try {
        return JSON.parse(text);
      } catch {
        return null;
      }
    }

    function tryParseXmlToJson(xmlText) {
      try {
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlText, "text/xml");
        if (xml.querySelector("parsererror")) return null;

        // ë§¤ìš° ë‹¨ìˆœí•œ XML->JSON (í•„ìš” ìµœì†Œ)
        const obj = {};
        xmlToJson(xml.documentElement, obj);
        return obj;
      } catch {
        return null;
      }
    }

    function xmlToJson(node, out) {
      const children = Array.from(node.children || []);
      if (children.length === 0) {
        out[node.nodeName] = node.textContent;
        return;
      }

      // ë™ì¼ íƒœê·¸ ë°˜ë³µì€ ë°°ì—´ ì²˜ë¦¬
      const map = {};
      for (const child of children) {
        map[child.nodeName] = map[child.nodeName] || [];
        const childObj = {};
        xmlToJson(child, childObj);
        map[child.nodeName].push(childObj[child.nodeName] ?? childObj);
      }

      // single ë°°ì—´ì€ ë‹¨ì¼ë¡œ í’€ì§€ ì•Šê³  ìœ ì§€
      out[node.nodeName] = map;
    }

    function extractItems(data) {
      // JSON ìŠ¤í‚¤ë§ˆ í›„ë³´ë“¤
      // - response.body.items.item
      // - getFoodKr.item
      // - item
      const candidates = [
        data?.getFoodKr?.item,
        data?.getFood?.item,
        data?.response?.body?.items?.item,
        data?.items?.item,
        data?.item,
      ];
      for (const c of candidates) {
        if (Array.isArray(c)) return c;
      }

      // XML->JSON ë³€í™˜ì€ êµ¬ì¡°ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë‹ˆ, í‚¤ ìŠ¤ìº”
      const flat = deepFindArray(data, ["item"]);
      if (flat) return flat;

      return [];
    }

    function deepFindArray(obj, keys) {
      if (!obj || typeof obj !== "object") return null;
      for (const k of Object.keys(obj)) {
        const v = obj[k];
        if (keys.includes(k) && Array.isArray(v)) return v;
        const found = deepFindArray(v, keys);
        if (found) return found;
      }
      return null;
    }

    /**********************
     * 5) ë Œë”ë§
     **********************/
    function renderSkeleton() {
      // Detail skeleton
      $("#heroImg").src = FALLBACK_IMG;
      $("#detailPanel").innerHTML = `
        <div class="section-title">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
        <div class="kv-row"><span class="tag">ìƒí˜¸ëª…</span><div class="val skeleton" style="height:18px;border-radius:10px;"></div></div>
        <div class="kv-row"><span class="tag">ì£¼ì†Œ</span><div class="val skeleton" style="height:18px;border-radius:10px;"></div></div>
        <div class="kv-row"><span class="tag">ì†Œê°œ</span><div class="val skeleton" style="height:72px;border-radius:14px;"></div></div>
        <div class="kv-row"><span class="tag">ëŒ€í‘œë©”ë‰´</span><div class="val skeleton" style="height:36px;border-radius:14px;"></div></div>
        <div class="kv-row"><span class="tag">ë¬¸ì˜</span><div class="val skeleton" style="height:18px;border-radius:10px;"></div></div>
        <div class="kv-row"><span class="tag">ìš´ì˜ì‹œê°„</span><div class="val skeleton" style="height:18px;border-radius:10px;"></div></div>
      `;

      // List skeleton
      $("#listView").innerHTML = Array.from({length: 6}).map(() => `
        <div class="list-item">
          <div>
            <div class="skeleton" style="height:16px;width:55%;border-radius:10px;margin-bottom:10px"></div>
            <div class="skeleton" style="height:12px;width:80%;border-radius:10px;margin-bottom:8px"></div>
            <div class="skeleton" style="height:12px;width:65%;border-radius:10px"></div>
          </div>
          <div class="li-actions">
            <div class="icon-btn skeleton" style="width:34px;height:34px"></div>
            <div class="icon-btn skeleton" style="width:34px;height:34px"></div>
          </div>
        </div>
      `).join("");
    }

    function renderList() {
      const listEl = $("#listView");
      const items = state.filtered;

      if (!items.length) {
        listEl.innerHTML = `
          <div class="list-item" style="cursor:default">
            <div>
              <p class="li-title">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
              <p class="li-meta">ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ ë³´ì„¸ìš”.</p>
            </div>
          </div>
        `;
        return;
      }

      listEl.innerHTML = items.map((it) => {
        const menuPreview = it.menus.slice(0, 2).join(", ") || "ëŒ€í‘œë©”ë‰´ ì •ë³´ ì—†ìŒ";
        const fav = isFav(it.id);

        return `
          <div class="list-item" data-id="${escapeHtml(it.id)}">
            <div>
              <p class="li-title">${escapeHtml(it.title)}</p>
              <p class="li-meta">ì£¼ì†Œ: ${escapeHtml(it.addr)}</p>
              <p class="li-meta">ë©”ë‰´: ${escapeHtml(menuPreview)}</p>
            </div>
            <div class="li-actions">
              <div class="icon-btn" data-action="open" title="ìƒì„¸ë³´ê¸°">ğŸ”</div>
              <div class="icon-btn" data-action="fav" title="ì¦ê²¨ì°¾ê¸°">${fav ? "â¤ï¸" : "ğŸ¤"}</div>
            </div>
          </div>
        `;
      }).join("");
    }

    function renderDetail() {
      const it = state.selected;
      if (!it) return;

      $("#heroImg").src = it.img || FALLBACK_IMG;
      $("#heroImg").alt = `${it.title} ì´ë¯¸ì§€`;

      const fav = isFav(it.id);
      $("#favBtn").innerHTML = fav
        ? "<span style='font-size:18px'>â¤ï¸</span>"
        : `
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M12 21s-7-4.6-9.5-8.5C0 9 2 5.8 5.7 5.2c2-.3 3.6.6 4.5 1.8.9-1.2 2.5-2.1 4.5-1.8C18.4 5.8 20.4 9 21.5 12.5 19 16.4 12 21 12 21z" stroke="rgba(255,255,255,.92)" stroke-width="1.6"/>
          </svg>
        `;

      const menuChips = it.menus.length
        ? `<div class="menu-chips">${it.menus.map(m => `<span class="chip">${escapeHtml(m)}</span>`).join("")}</div>`
        : `<div class="val muted">(ëŒ€í‘œë©”ë‰´ ì •ë³´ ì—†ìŒ)</div>`;

      const homepage = it.homepage && it.homepage.startsWith("http")
        ? `<a class="chip" href="${escapeHtml(it.homepage)}" target="_blank" rel="noreferrer">ê³µì‹/í™ˆí˜ì´ì§€</a>`
        : "";

      $("#detailPanel").innerHTML = `
        <div class="kv-row"><span class="tag">ìƒí˜¸ëª…</span><div class="val">${escapeHtml(it.title)}</div></div>
        <div class="kv-row"><span class="tag">ì£¼ì†Œ</span><div class="val">${escapeHtml(it.addr)}</div></div>
        <div class="kv-row"><span class="tag">ì†Œê°œ</span><div class="val">${escapeHtml(it.desc)}</div></div>
        <div class="kv-row"><span class="tag">ëŒ€í‘œë©”ë‰´</span><div>${menuChips}</div></div>
        <div class="kv-row"><span class="tag">ë¬¸ì˜</span><div class="val">${escapeHtml(it.tel)}</div></div>
        <div class="kv-row"><span class="tag">ìš´ì˜ì‹œê°„</span><div class="val">${escapeHtml(it.usageTime)}</div></div>
        ${homepage ? `<div class="section-title">ë§í¬</div><div class="menu-chips">${homepage}</div>` : ""}
        <button class="btn" id="copyAddrBtn" type="button">ì£¼ì†Œ ë³µì‚¬</button>
      `;

      // ì§€ë„ ì—…ë°ì´íŠ¸
      updateMap(it);

      // ì´ë²¤íŠ¸(ì£¼ì†Œ ë³µì‚¬)
      const copyBtn = $("#copyAddrBtn");
      copyBtn?.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(it.addr);
          copyBtn.textContent = "ë³µì‚¬ ì™„ë£Œ âœ“";
          setTimeout(() => (copyBtn.textContent = "ì£¼ì†Œ ë³µì‚¬"), 900);
        } catch {
          alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        }
      });
    }

    /**********************
     * 6) ì¹´ì¹´ì˜¤ë§µ
     **********************/
    function ensureKakaoLoaded() {
      return new Promise((resolve, reject) => {
        if (!window.kakao || !window.kakao.maps) {
          reject(new Error("ì¹´ì¹´ì˜¤ë§µ SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. appkeyë¥¼ í™•ì¸í•˜ì„¸ìš”."));
          return;
        }
        window.kakao.maps.load(() => resolve());
      });
    }

    async function initMap() {
      try {
        await ensureKakaoLoaded();
        $("#kakaoNotice").classList.add("hidden");

        // ë¶€ì‚° ì‹œì²­ ê·¼ì²˜ ê¸°ë³¸ ì¢Œí‘œ
        const center = new kakao.maps.LatLng(35.1796, 129.0756);
        state.map = new kakao.maps.Map($("#map"), {
          center,
          level: 6,
        });

        state.marker = new kakao.maps.Marker({ position: center });
        state.marker.setMap(state.map);
      } catch (err) {
        // SDK ì—†ì´ë„ UIëŠ” ë™ì‘í•˜ë„ë¡ ìœ ì§€
        console.warn(err);
      }
    }

    function updateMap(item) {
      if (!state.map || !window.kakao?.maps) return;

      const lat = item.lat;
      const lng = item.lng;

      // ì¢Œí‘œê°€ ì—†ìœ¼ë©´ ì£¼ì†Œ ê¸°ë°˜ ì§€ì˜¤ì½”ë”©ì„ ì‹œë„í•˜ë ¤ë©´ Kakao services ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.
      // ì—¬ê¸°ì„œëŠ” ì¢Œí‘œê°€ ìˆì„ ë•Œë§Œ ë§ˆì»¤ ì´ë™.
      if (lat == null || lng == null) return;

      const pos = new kakao.maps.LatLng(lat, lng);
      state.map.setCenter(pos);
      state.marker.setPosition(pos);
    }

    /**********************
     * 7) ì´ë²¤íŠ¸/ê²€ìƒ‰
     **********************/
    function applyFilter(query) {
      const q = query.trim().toLowerCase();
      if (!q) {
        state.filtered = [...state.items];
      } else {
        state.filtered = state.items.filter(it => {
          return (
            it.title.toLowerCase().includes(q) ||
            it.addr.toLowerCase().includes(q) ||
            it.menuRaw.toLowerCase().includes(q)
          );
        });
      }
      renderList();

      // ì„ íƒëœ ì•„ì´í…œì´ í•„í„°ì—ì„œ ì‚¬ë¼ì§€ë©´, ì²« ë²ˆì§¸ë¡œ êµì²´
      if (state.selected && !state.filtered.some(it => it.id === state.selected.id)) {
        state.selected = state.filtered[0] || null;
        if (state.selected) renderDetail();
      }
    }

    function bindUI() {
      // ëª©ë¡ í´ë¦­(ìƒì„¸ë³´ê¸° / ì¦ê²¨ì°¾ê¸°)
      $("#listView").addEventListener("click", (e) => {
        const itemEl = e.target.closest(".list-item");
        if (!itemEl) return;
        const id = itemEl.getAttribute("data-id");
        const action = e.target?.getAttribute?.("data-action");

        if (action === "fav") {
          toggleFav(id);
          return;
        }

        // ìƒì„¸ ì—´ê¸°
        selectById(id);
      });

      // ì¦ê²¨ì°¾ê¸°(ìƒë‹¨ ì•„ì´ì½˜)
      $("#favBtn").addEventListener("click", () => {
        if (!state.selected) return;
        toggleFav(state.selected.id);
      });

      // ê²€ìƒ‰
      const qEl = $("#q");
      qEl.addEventListener("input", () => applyFilter(qEl.value));

      // ìƒˆë¡œê³ ì¹¨
      $("#refreshBtn").addEventListener("click", () => bootstrap());

      // í™ˆ(ë¸Œëœë“œ í´ë¦­) -> ì²« í•­ëª©ìœ¼ë¡œ
      $("#goHome").addEventListener("click", () => {
        $("#q").value = "";
        applyFilter("");
        if (state.filtered[0]) selectById(state.filtered[0].id);
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    }

    function selectById(id) {
      const it = state.items.find(x => String(x.id) === String(id));
      if (!it) return;
      state.selected = it;
      renderDetail();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    /**********************
     * 8) ì´ˆê¸°í™”
     **********************/
    async function bootstrap() {
      renderSkeleton();

      try {
        const rawItems = await fetchFoodList();
        state.items = rawItems.map(toItem);
        state.filtered = [...state.items];

        // ê¸°ë³¸ ì„ íƒ
        state.selected = state.items[0] || null;

        renderList();
        if (state.selected) renderDetail();

        // ì§€ë„ëŠ” ë³„ë„ ì´ˆê¸°í™”
        await initMap();
        if (state.selected) updateMap(state.selected);

      } catch (err) {
        console.error(err);
        $("#detailPanel").innerHTML = `
          <div class="section-title">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>
          <div class="val muted">ê³µê³µë°ì´í„° API í˜¸ì¶œ/íŒŒì‹±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>
          <div class="val muted" style="margin-top:8px">
            <b>í™•ì¸ í¬ì¸íŠ¸</b><br/>
            1) FoodService ì—”ë“œí¬ì¸íŠ¸(getFoodKr ë“±)ê°€ ì‹¤ì œë¡œ ë§ëŠ”ì§€<br/>
            2) resultType / numOfRows / pageNo ë“± íŒŒë¼ë¯¸í„°ê°€ ë§ëŠ”ì§€<br/>
            3) ë¸Œë¼ìš°ì € CORS ì •ì±…ìœ¼ë¡œ ì°¨ë‹¨ë˜ëŠ”ì§€(ê°œë°œ ì‹œ ë¡œì»¬ í”„ë¡ì‹œ í•„ìš”í•  ìˆ˜ ìˆìŒ)
          </div>
          <button class="btn" id="retryBtn" type="button">ë‹¤ì‹œ ì‹œë„</button>
        `;
        $("#listView").innerHTML = `
          <div class="list-item" style="cursor:default">
            <div>
              <p class="li-title">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
              <p class="li-meta">ê°œë°œì ë„êµ¬ ì½˜ì†”ì—ì„œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>
            </div>
          </div>
        `;
        $("#retryBtn")?.addEventListener("click", () => bootstrap());
      }
    }

    // ì´ˆê¸° ì‹¤í–‰
    bindUI();
    bootstrap();

  </script>
</body>
</html>
